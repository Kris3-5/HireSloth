<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Force HTTPS except localhost -->
  <script>
    if (location.protocol === 'http:' &&
        location.hostname !== 'localhost' &&
        location.hostname !== '127.0.0.1') {
      location.replace('https://' + location.host + location.pathname + location.search + location.hash);
    }
  </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

  <title>HireSloth - My Jobs</title>
  <link rel="canonical" href="https://hiresloth.com/my-jobs.html">
  <meta name="description" content="Manage the jobs your company has posted on HireSloth.">
  <link rel="icon" href="favicon.ico">

  <!-- Fonts & perf -->
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <!-- Replace "mylink" with your Supabase URL, e.g. https://abc.supabase.co -->
  <link rel="preconnect" href="https://arzddicguiydfvtwewlq.supabase.co" crossorigin>

  <link rel="stylesheet" href="style.css?v=20250912a">

  <!-- Make the Verify button match Post a Job (scoped to this page) -->
  <style>
    #verifyBtnNav{
      background:linear-gradient(135deg, var(--brand-2), var(--brand));
      color:var(--cream);
      border-radius:12px;
      padding:.55rem .9rem;
      box-shadow:var(--shadow-sm);
    }
    #verifyBtnNav:hover{ transform:translateY(-1px); box-shadow:var(--shadow) }
    /* Tiny verified badge style (used in banner) */
    .badge--verified{
      display:inline-flex; align-items:center; gap:.35rem;
      padding:.15rem .55rem; border-radius:999px; font-size:.78rem;
      border:1px solid #2ecc71; color:#2ecc71; line-height:1;
    }
    .badge--verified svg{ width:14px; height:14px; }
  </style>
</head>
<body>
  <header>
    <a href="index.html" class="logo">
      <img
        src="logo.jpg?v=2"
        alt="HireSloth Logo"
        width="120"
        height="120"
        loading="eager"
        fetchpriority="high"
        decoding="async"
        onerror="
          if (!this.dataset.fallbackTried) {
            this.dataset.fallbackTried = '1';
            this.src = 'logo.jpg?v=2';
          } else { this.onerror=null; }">
    </a>

    <nav>
      <a href="index.html">Home</a>
      <a href="jobs.html">Vacancies</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
      <a href="my-jobs.html" class="active" id="myJobsBtn">My Jobs</a>
      <a href="post-job.html" id="postJobBtn">Post a Job</a>
      <a href="verify.html" id="verifyBtnNav" class="btn">Get Verified</a>
      <a href="auth.html" id="authBtn">Sign In</a>
    </nav>
  </header>

  <main class="content">
    <h1>My Job Listings</h1>
    <p>Here you can see and manage the jobs your company has posted.</p>

    <!-- Optional banner: shows status and a secondary ‚ÄúGet Verified‚Äù link if needed -->
    <div id="verifyBanner" class="job-card" style="margin-top:1rem; text-align:left;"></div>

    <div id="jobsList" class="jobs"></div>
  </main>

  <footer><p>&copy; 2025 HireSloth. All rights reserved.</p></footer>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3/+esm";

    const SUPABASE_URL = "https://arzddicguiydfvtwewlq.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyemRkaWNndWl5ZGZ2dHdld2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MzA5NDcsImV4cCI6MjA3MzAwNjk0N30.UjZj0XeB8BtjSDsFyf9swxHA26OniI1Mk1ddgSTUXYg";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    const jobsList = document.getElementById("jobsList");
    const bannerEl = document.getElementById("verifyBanner");

    // -------- Require auth (redirect if not) --------
    let session;
    try {
      ({ data: { session } } = await supabase.auth.getSession());
    } catch { session = null; }
    const currentUser = session?.user || null;
    if (!currentUser) {
      localStorage.setItem("hs_authed","0");
      location.href = "auth.html?mode=signin&returnTo=" + encodeURIComponent("my-jobs.html");
      throw new Error("Redirecting to auth");
    }
    localStorage.setItem("hs_authed","1");

    // -------- Verification banner (supports profiles.verified_until or companies.is_verified) --------
    async function showVerifyBanner(){
      if (!bannerEl) return;

      // Try companies first (if you have that table); fall back to profiles
      let isVerified = false;
      let untilDate = null;

      try {
        // profiles path
        const { data: prof, error: profErr } = await supabase
          .from("profiles")
          .select("verified_until")
          .eq("id", currentUser.id)
          .maybeSingle();

        if (!profErr && prof?.verified_until) {
          const today = new Date(); today.setHours(0,0,0,0);
          const until = new Date(prof.verified_until);
          if (until >= today) { isVerified = true; untilDate = until; }
        }
      } catch {}

      // Optional companies path (ignore if table/policy missing)
      if (!isVerified) {
        try {
          const { data: comp, error: compErr } = await supabase
            .from("companies")
            .select("is_verified")
            .eq("user_id", currentUser.id)
            .maybeSingle();
          if (!compErr && comp?.is_verified) isVerified = true;
        } catch {}
      }

      if (isVerified) {
        bannerEl.innerHTML = `
          <p>
            <span class="badge--verified">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M9.55 17.05 5.5 13l1.4-1.4 2.65 2.6 7.6-7.6L18.55 8z"/></svg>
              Verified
            </span>
            &nbsp;Your employer badge is active${untilDate ? " until <strong>"+untilDate.toLocaleDateString()+"</strong>" : ""}.
          </p>`;
      } else {
        bannerEl.innerHTML = `
          <p><strong>No active employer verification.</strong>
          &nbsp;<a class="btn" href="verify.html">Get Verified</a></p>`;
      }
    }
    showVerifyBanner();

    // -------- Helpers --------
    const esc = (s) => (s ?? "").toString()
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");

    // -------- Load user's jobs --------
    async function loadJobs() {
      jobsList.innerHTML = "<p>Loading jobs‚Ä¶</p>";

      const { data, error } = await supabase
        .from("jobs")
        .select("*")
        .eq("user_id", currentUser.id)
        .order("created_at", { ascending: false });

      if (error) {
        jobsList.innerHTML = `<p style="color:red">‚ùå Error loading jobs: ${esc(error.message)}</p>`;
        console.error(error);
        return;
      }
      if (!data || data.length === 0) {
        jobsList.innerHTML = `<p>No jobs posted yet. <a href="post-job.html">Post your first job</a>.</p>`;
        return;
      }

      jobsList.innerHTML = "";
      data.forEach(job => {
        const card = document.createElement("div");
        card.className = "job-card";
        card.innerHTML = `
          <h3>${esc(job.title)}</h3>
          <p><strong>Location:</strong> ${esc(job.location || "Not specified")}${job.remote ? " (Remote)" : ""}</p>
          <p>${esc(job.description || "")}</p>
          ${job.contact_email ? `<p><strong>Contact Email:</strong> ${esc(job.contact_email)}</p>` : ""}
          <div style="display:flex; gap:.5rem; flex-wrap:wrap">
            <button class="deleteBtn btn danger" data-id="${esc(job.id)}">üóë Delete</button>
            ${job.is_active === false ? `<span class="badge">Inactive</span>` : ``}
          </div>
        `;
        jobsList.appendChild(card);
      });

      document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const jobId = e.currentTarget.dataset.id;
          if (!confirm("Are you sure you want to delete this job?")) return;

          const { error } = await supabase
            .from("jobs")
            .delete()
            .eq("id", jobId)
            .eq("user_id", currentUser.id);

          if (error) alert("‚ùå Error deleting job: " + error.message);
          else loadJobs();
        });
      });
    }
    loadJobs();
  </script>

  <!-- Shared nav/auth logic -->
  <script type="module" src="nav.js"></script>
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js", { scope: "./" }).catch(()=>{});
    }
  </script>
</body>
</html>
