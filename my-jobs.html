<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Force HTTPS in production; allow localhost for dev -->
<script>
  if (location.protocol === 'http:' &&
      location.hostname !== 'localhost' &&
      location.hostname !== '127.0.0.1') {
    location.replace('https://' + location.host + location.pathname + location.search + location.hash);
  }
</script>

<!-- Auto-upgrade any accidental http:// subresources to https:// -->
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

  <title>HireSloth - My Jobs</title>
  <!-- Favicons -->
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="shortcut icon" href="/favicon.ico">

<!-- iOS home screen icon -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<meta name="apple-mobile-web-app-title" content="HireSloth">

<!-- PWA manifest (Android/Chrome uses this for 192/512) -->
<link rel="manifest" href="/site.webmanifest">
  <!-- Help Google pick your site name -->
<meta name="application-name" content="HireSloth">
<meta property="og:site_name" content="HireSloth">

<!-- Address bar color (light/dark) -->
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#715336">
<meta name="theme-color" media="(prefers-color-scheme: dark)"  content="#2a241e">
  <!-- Fonts: faster than @import -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://arzddicguiydfvtwewlq.supabase.co" crossorigin>
  <link rel="stylesheet" href="style.css?v=20250912a">
</head>
<body>
  <header>
    <a href="index.html" class="logo"><img src="logo.jpg" alt="HireSloth Logo"></a>
    <nav>
      <a href="index.html">Home</a>
      <a href="jobs.html">Vacancies</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
      <a href="my-jobs.html" id="myJobsBtn" class="active">My Jobs</a>
      <a href="post-job.html" id="postJobBtn">Post a Job</a>
      <a href="auth.html" id="authBtn">Sign In</a>
    </nav>
  </header>

  <main class="content">
    <h1>My Job Listings</h1>
    <p>Here you can see and manage the jobs your company has posted.</p>
    <div id="jobsList" class="jobs"></div>
  </main>

  <footer><p>&copy; 2025 HireSloth. All rights reserved.</p></footer>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3/+esm";
    const SUPABASE_URL="https://arzddicguiydfvtwewlq.supabase.co"; const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyemRkaWNndWl5ZGZ2dHdld2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MzA5NDcsImV4cCI6MjA3MzAwNjk0N30.UjZj0XeB8BtjSDsFyf9swxHA26OniI1Mk1ddgSTUXYg";
    const supabase=createClient(SUPABASE_URL,SUPABASE_ANON_KEY,{auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:true}});

    const authBtn=document.getElementById("authBtn");
    const jobsList=document.getElementById("jobsList");
    const esc=(s)=>(s??"").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");

    let currentUser=null;

    // Get session once; no timeouts
    const { data:{ session } } = await supabase.auth.getSession();
    currentUser = session?.user || null;

    // Hard gate
    if(!currentUser){
      location.replace("auth.html?mode=signin&returnTo="+encodeURIComponent("my-jobs.html"));
    }

    // Auth button (confirm on logout)
    function updateAuthBtn(){
      if(currentUser){
        authBtn.textContent="Sign Out"; authBtn.href="#";
        authBtn.onclick=async(e)=>{ e.preventDefault(); if(!confirm("Are you sure you want to log out?")) return; await supabase.auth.signOut(); location.href="index.html"; };
      }else{
        authBtn.textContent="Sign In"; authBtn.href="auth.html"; authBtn.onclick=null;
      }
    }
    updateAuthBtn();
    supabase.auth.onAuthStateChange((event,session)=>{
      if(event==="SIGNED_IN"||event==="SIGNED_OUT"||event==="USER_UPDATED"){
        currentUser=session?.user||null; updateAuthBtn();
      }
    });

    async function loadJobs(){
      if(!currentUser) return;
      jobsList.innerHTML="<p>Loading jobs...</p>";
      const { data, error } = await supabase
        .from("jobs").select("*")
        .eq("user_id", currentUser.id)
        .order("created_at",{ascending:false});
      if(error){ jobsList.innerHTML="<p>‚ùå Error loading jobs.</p>"; console.error(error); return; }
      if(!data || data.length===0){ jobsList.innerHTML=`<p>No jobs posted yet. <a href="post-job.html">Post your first job</a>.</p>`; return; }

      jobsList.innerHTML="";
      data.forEach(job=>{
        const card=document.createElement("div");
        card.className="job-card";
        card.innerHTML=`
          <h3>${esc(job.title)}</h3>
          <p><strong>Location:</strong> ${esc(job.location||"Not specified")}${job.remote?" (Remote)":""}</p>
          <p>${esc(job.description||"")}</p>
          ${job.contact_email?`<p><strong>Contact Email:</strong> ${esc(job.contact_email)}</p>`:""}
          <div class="actions"><button class="deleteBtn" data-id="${esc(job.id)}">üóë Delete</button></div>
        `;
        jobsList.appendChild(card);
      });

      document.querySelectorAll(".deleteBtn").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          const jobId=e.currentTarget.dataset.id;
          if(!confirm("Delete this job?")) return;
          e.currentTarget.disabled=true; e.currentTarget.textContent="Deleting‚Ä¶";
          const { error } = await supabase.from("jobs").delete().eq("id",jobId).eq("user_id",currentUser.id);
          if(error){ alert("‚ùå Error deleting job: "+error.message); e.currentTarget.disabled=false; e.currentTarget.textContent="üóë Delete"; }
          else{ loadJobs(); }
        });
      });
    }
    loadJobs();
  </script>
</body>
</html>
