<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin ‚Äì HireSloth</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <script>
    if (location.protocol === 'http:' &&
        location.hostname !== 'localhost' &&
        location.hostname !== '127.0.0.1') {
      location.replace('https://' + location.host + location.pathname + location.search + location.hash);
    }
  </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <link rel="icon" href="favicon.ico">
  <link rel="stylesheet" href="style.css?v=20250912b">
</head>
<body>
<header>
  <a href="index.html" class="logo" aria-label="HireSloth Home">
    <img src="logo.jpg?v=2" alt="HireSloth Logo" width="120" height="120" loading="eager" fetchpriority="high" decoding="async"
      onerror="if (!this.dataset.fallbackTried) { this.dataset.fallbackTried='1'; this.src='logo.jpg?v=2'; } else { this.onerror=null; }">
  </a>
  <nav aria-label="Primary">
    <a href="index.html">Home</a>
    <a href="jobs.html">Vacancies</a>
    <a href="about.html">About</a>
    <a href="contact.html">Contact</a>
    <a href="my-jobs.html" id="myJobsBtn">My Jobs</a>
    <a href="post-job.html" id="postJobBtn">Post a Job</a>
    <!-- Always present; nav.js gates the click if signed out -->
    <a href="verify.html" id="verifyBtnNav" class="btn">Get Verified</a>
    <a href="auth.html" id="authBtn">Sign In</a>
  </nav>
</header>

<main class="content" style="text-align:left">
  <h1>Admin Dashboard</h1>
  <p class="visually-hidden" id="adminStatus" aria-live="polite"></p>

  <section id="guard"></section>

  <section id="pendingSection" style="display:none;">
    <h2>Pending approvals</h2>
    <div class="jobs" id="pendingList"></div>
  </section>

  <section style="margin-top:2rem;">
    <h2>Mark employer verified (by User ID)</h2>
    <form id="verifyByIdForm" style="max-width:560px;margin:1rem 0;">
      <label for="verifUserId">Supabase User ID</label>
      <input type="text" id="verifUserId" required placeholder="paste client_reference_id from Stripe">
      <label for="verifUntilId">Verified until</label>
      <input type="date" id="verifUntilId" required>
      <button type="submit">Save</button>
    </form>
    <p id="verifyByIdMsg" aria-live="polite"></p>
  </section>

  <section id="recentSection" style="display:none; margin-top:2rem;">
    <h2>Recent jobs</h2>
    <div class="jobs" id="recentList"></div>
  </section>

  <section id="companySection" style="display:none; margin-top:2rem;">
    <h2>Companies</h2>

    <div class="search-bar" style="display:flex; gap:.5rem; flex-wrap:wrap;">
      <input id="companyQuery" placeholder="Search by name, email, company_id or user_id" style="min-width:260px;">
      <button id="companySearchBtn" class="btn">Search</button>
      <button id="companyListUnverifiedBtn" class="btn btn-alt">List unverified</button>
    </div>

    <div id="companyResults" class="jobs" style="margin-top:1rem;"></div>

    <h3 style="margin-top:2rem;">Create / attach company to a user</h3>
    <form id="companyCreateForm" style="max-width:560px;margin:1rem 0;">
      <label for="c_user_id">User ID</label>
      <input id="c_user_id" required placeholder="auth.users.id (uuid)">
      <label for="c_name">Company name</label>
      <input id="c_name" placeholder="Acme Inc.">
      <label for="c_email">Company email</label>
      <input id="c_email" type="email" placeholder="hr@acme.com">
      <button type="submit">Save</button>
    </form>
    <p id="companyCreateMsg" aria-live="polite"></p>
  </section>
</main>

<footer><p>&copy; 2025 HireSloth. All rights reserved.</p></footer>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3/+esm";

  const SUPABASE_URL = "https://arzddicguiydfvtwewlq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyemRkaWNndWl5ZGZ2dHdld2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MzA5NDcsImV4cCI6MjA3MzAwNjk0N30.UjZj0XeB8BtjSDsFyf9swxHA26OniI1Mk1ddgSTUXYg";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });

  const guardEl = document.getElementById("guard");
  const adminStatus = document.getElementById("adminStatus");
  const pendingSection = document.getElementById("pendingSection");
  const recentSection = document.getElementById("recentSection");
  const pendingList = document.getElementById("pendingList");
  const recentList = document.getElementById("recentList");

  // ======= Companies admin helpers =======
  const companySection   = document.getElementById("companySection");
  const companyQuery     = document.getElementById("companyQuery");
  const companySearchBtn = document.getElementById("companySearchBtn");
  const companyListBtn   = document.getElementById("companyListUnverifiedBtn");
  const companyResults   = document.getElementById("companyResults");

  function esc(s){ return (s ?? "").toString()
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }

  function companyCard(c){
    const when = c.verified_at ? new Date(c.verified_at).toLocaleString() : "‚Äî";
    return `
      <div class="job-card" data-company-id="${esc(c.id)}" data-user-id="${esc(c.user_id)}">
        <h3>${esc(c.name || "(no name)")}</h3>
        <p><strong>Company ID:</strong> ${esc(c.id)}</p>
        <p><strong>User ID:</strong> ${esc(c.user_id)}</p>
        <p><strong>Email:</strong> ${esc(c.email || "‚Äî")}</p>
        <p><strong>Verified:</strong> ${c.is_verified ? "‚úÖ yes" : "‚ùå no"} ${c.is_verified ? `‚Ä¢ since: ${when}` : ""}</p>
        <div class="actions" style="margin-top:.5rem; display:flex; gap:.5rem; flex-wrap:wrap;">
          <button class="btn" data-action="verify12">Verify for 12 months</button>
          <button class="btn secondary" data-action="unverify">Unverify</button>
        </div>
      </div>
    `;
  }

  async function searchCompanies(q, listUnverified=false){
    companyResults.innerHTML = "<p>Loading‚Ä¶</p>";
    let qb = supabase
      .from("companies")
      .select("id,user_id,name,email,is_verified,verified_at,created_at")
      .order("created_at", { ascending:false })
      .limit(100);

    if (listUnverified){
      qb = qb.eq("is_verified", false);
    } else if (q){
      const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(q);
      if (isUuid){
        qb = qb.or(`id.eq.${q},user_id.eq.${q}`);
      } else {
        qb = qb.or(`name.ilike.%${q}%,email.ilike.%${q}%`);
      }
    }

    const { data, error } = await qb;
    if (error) { companyResults.innerHTML = `<p style="color:red">Error: ${esc(error.message)}</p>`; return; }
    if (!data?.length) { companyResults.innerHTML = "<p>No companies found.</p>"; return; }
    companyResults.innerHTML = data.map(companyCard).join("");
    wireCompanyButtons();
  }

  function addDays(date, n){ const d = new Date(date); d.setUTCDate(d.getUTCDate()+n); return d; }

  async function verifyCompanyFor12Months(companyId, userId){
    const until = addDays(new Date(), 365).toISOString().slice(0,10); // yyyy-mm-dd for DATE
    const nowIso = new Date().toISOString();

    const [p1, p2] = await Promise.all([
      supabase.from("profiles").upsert([{ id: userId, verified_until: until }], { onConflict: "id" }),
      supabase.from("companies").update({ is_verified: true, verified_at: nowIso, verified_by: "admin" }).eq("id", companyId)
    ]);
    if (p1.error) throw p1.error;
    if (p2.error) throw p2.error;
  }

  async function unverifyCompany(companyId, userId){
    const [p1, p2] = await Promise.all([
      supabase.from("profiles").upsert([{ id: userId, verified_until: null }], { onConflict: "id" }),
      supabase.from("companies").update({ is_verified: false, verified_at: null, verified_by: null }).eq("id", companyId)
    ]);
    if (p1.error) throw p1.error;
    if (p2.error) throw p2.error;
  }

  function wireCompanyButtons(){
    companyResults.querySelectorAll(".job-card").forEach(card=>{
      const companyId = card.dataset.companyId;
      const userId    = card.dataset.userId;

      card.querySelectorAll("button[data-action]").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          const action = e.currentTarget.dataset.action;

          // ‚úÖ Ask first; only disable if proceeding
          if (action === "unverify") {
            const ok = confirm("Remove verification for this company?");
            if (!ok) return;
          }

          e.currentTarget.disabled = true;
          try {
            if (action === "verify12") {
              await verifyCompanyFor12Months(companyId, userId);
            } else if (action === "unverify") {
              await unverifyCompany(companyId, userId);
            }
          } catch(err){
            alert("Error: " + (err.message || err));
          } finally {
            await searchCompanies(companyQuery.value.trim());
          }
        });
      });
    });
  }

  function wireCompaniesUI(){
    companySearchBtn.addEventListener("click", ()=>searchCompanies(companyQuery.value.trim()));
    companyListBtn.addEventListener("click", ()=>searchCompanies("", true));
    companyQuery.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); companySearchBtn.click(); }});
  }

  // ===== Verify-by-User-ID form (MISSING BEFORE ‚Äî now implemented) =====
  function wireVerifyByIdForm(){
    const form = document.getElementById("verifyByIdForm");
    const msg  = document.getElementById("verifyByIdMsg");
    const userInput  = document.getElementById("verifUserId");
    const untilInput = document.getElementById("verifUntilId");

    if (!form) return;

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      msg.textContent = ""; msg.style.color = "";

      const user_id = (userInput.value || "").trim();
      const until   = (untilInput.value || "").trim(); // yyyy-mm-dd

      if (!user_id){ msg.textContent = "User ID is required."; msg.style.color = "red"; return; }
      if (!/^\d{4}-\d{2}-\d{2}$/.test(until)){ msg.textContent = "Date must be YYYY-MM-DD."; msg.style.color = "red"; return; }

      try {
        // 1) Set/extend the user‚Äôs verified_until
        const p1 = await supabase
          .from("profiles")
          .upsert([{ id: user_id, verified_until: until }], { onConflict: "id" });

        if (p1.error) throw p1.error;

        // 2) (Optional) Mark all that user‚Äôs companies as verified
        const nowIso = new Date().toISOString();
        const p2 = await supabase
          .from("companies")
          .update({ is_verified: true, verified_at: nowIso, verified_by: "admin" })
          .eq("user_id", user_id);

        if (p2.error) throw p2.error;

        msg.textContent = "Verification saved ‚úì";
        msg.style.color = "green";
        form.reset();

        // Refresh visible company list if the admin is currently looking at that user
        const q = companyQuery.value.trim();
        if (q && q === user_id) { await searchCompanies(user_id); }
      } catch(err){
        msg.textContent = "Error: " + (err.message || err);
        msg.style.color = "red";
      }
    });
  }

  // ===== Jobs UI =====
  function jobCard(job, adminActions = true){
    const salary = job.salary ? `<p><strong>Salary:</strong> ${esc(job.salary)}</p>` : "";
    const resp = job.responsibilities ? `<p><strong>Responsibilities:</strong> ${esc(job.responsibilities)}</p>` : "";
    const status = `
      <small>
        ${job.approved ? "‚úÖ Approved" : "‚è≥ Pending"}
        ‚Ä¢ ${job.is_active ? "üü¢ Active" : "‚ö™ Inactive"}
        ‚Ä¢ Expires: ${job.expires_at ? new Date(job.expires_at).toLocaleDateString() : "‚Äî"}
      </small>
    `;
    const actions = adminActions ? `
      <div class="actions" style="margin-top:.5rem">
        <button class="btn" data-action="approve" data-id="${esc(job.id)}">Approve</button>
        <button class="btn" data-action="deactivate" data-id="${esc(job.id)}">Deactivate</button>
        <button class="btn secondary" data-action="delete" data-id="${esc(job.id)}">Delete</button>
      </div>
    ` : "";
    return `
      <div class="job-card" id="job-${esc(job.id)}">
        <h3>${esc(job.title)}</h3>
        <p><strong>Company:</strong> ${esc(job.company || "")}</p>
        <p><strong>Location:</strong> ${esc(job.location || "N/A")} ${job.remote ? "(Remote)" : ""}</p>
        ${salary}
        <p><strong>Summary:</strong> ${esc(job.description || "")}</p>
        ${resp}
        ${status}
        ${actions}
      </div>
    `;
  }

  async function loadPending(){
    pendingList.innerHTML = "<p>Loading‚Ä¶</p>";
    const { data, error } = await supabase
      .from("jobs")
      .select("*")
      .eq("approved", false)
      .order("created_at", { ascending: false });

    if (error) { pendingList.innerHTML = `<p style="color:red;">Error: ${esc(error.message)}</p>`; return; }
    if (!data || data.length === 0) { pendingList.innerHTML = "<p>No pending jobs üéâ</p>"; return; }

    pendingList.innerHTML = data.map(j => jobCard(j, true)).join("");
    wireButtons(pendingList);
  }

  async function loadRecent(){
    recentList.innerHTML = "<p>Loading‚Ä¶</p>";
    const { data, error } = await supabase
      .from("jobs")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(12);

    if (error) { recentList.innerHTML = `<p style="color:red;">Error: ${esc(error.message)}</p>`; return; }
    if (!data || data.length === 0) { recentList.innerHTML = "<p>No jobs yet.</p>"; return; }

    recentList.innerHTML = data.map(j => jobCard(j, true)).join("");
    wireButtons(recentList);
  }

  function wireButtons(container){
    container.querySelectorAll("button[data-action]").forEach(btn=>{
      btn.addEventListener("click", async (e)=>{
        const el = e.currentTarget;
        const action = el.dataset.action;
        const id = el.dataset.id;

        // Ask first for destructive action
        if (action === "delete") {
          const ok = confirm("Delete this job permanently?");
          if (!ok) return;
        }

        el.disabled = true;

        try {
          if (action === "approve") {
            const { error } = await supabase.from("jobs").update({ approved: true, is_active: true }).eq("id", id);
            if (error) throw error;
            adminStatus.textContent = "Approved ‚úî";
          } else if (action === "deactivate") {
            const { error } = await supabase.from("jobs").update({ is_active: false }).eq("id", id);
            if (error) throw error;
            adminStatus.textContent = "Deactivated";
          } else if (action === "delete") {
            const { error } = await supabase.from("jobs").delete().eq("id", id);
            if (error) throw error;
            adminStatus.textContent = "Deleted";
          }
        } catch (err) {
          alert("Error: " + (err.message || err));
        } finally {
          await Promise.all([loadPending(), loadRecent()]);
        }
      });
    });
  }

  // ===== Admin gate =====
  async function requireAdmin() {
    const { data: { session } } = await supabase.auth.getSession();
    const user = session?.user;
    if (!user) {
      location.href = "auth.html?mode=signin&returnTo=" + encodeURIComponent("admin.html");
      throw new Error("Redirecting to sign in");
    }
    const { data, error } = await supabase
      .from("admins")
      .select("user_id")
      .eq("user_id", user.id)
      .maybeSingle();

    if (error) {
      guardEl.innerHTML = `<p style="color:#a33;"><strong>Error:</strong> ${esc(error.message)}</p>`;
      throw error;
    }
    if (!data) {
      guardEl.innerHTML = `
        <p style="color:#a33;"><strong>Access denied.</strong> You‚Äôre signed in, but not an admin.</p>
        <p><a class="btn" href="index.html">Back to site</a></p>
      `;
      throw new Error("Not admin");
    }

    pendingSection.style.display = "block";
    recentSection.style.display = "block";
    companySection.style.display = "block";
    guardEl.innerHTML = "";
    return user;
  }

  // ===== Boot =====
  (async ()=>{
    try {
      await requireAdmin();
      wireCompaniesUI();
      wireVerifyByIdForm();   // <-- now exists
      await Promise.all([loadPending(), loadRecent()]);
    } catch (err) {
      console.warn(err?.message || err);
    }
  })();
</script>

<!-- Shared nav/auth logic -->
<script type="module" src="nav.js?v=20250920e"></script>
<script>
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js?v=15', { scope: './' }).catch(()=>{}); }
</script>
</body>
</html>
