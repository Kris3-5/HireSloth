<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script>
    // Force HTTPS off localhost
    if (location.protocol === 'http:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
      location.replace('https://' + location.host + location.pathname + location.search + location.hash);
    }
  </script>
  <!-- CSP is fine for email/password auth; if you add OAuth popups, expand as needed -->
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <title>HireSloth - Sign In / Sign Up</title>
  <link rel="canonical" href="https://hiresloth.com/auth.html">
  <meta name="description" content="Sign in or create a HireSloth account to post jobs.">
  <link rel="icon" href="favicon.ico">
  <!-- Fonts & perf -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="style.css?v=20250912a"/>
  <style>
    .tabs{display:inline-flex;gap:.4rem;background:#fff;border:1px solid rgba(113,83,54,.12);border-radius:12px;padding:.35rem;box-shadow:0 4px 12px rgba(0,0,0,.08);margin:1rem auto 0}
    .tab-btn{border:none;padding:.6rem 1rem;border-radius:10px;font-weight:700;cursor:pointer;background:transparent;color:#715336}
    .tab-btn[aria-selected="true"]{background:linear-gradient(135deg,#A18F7B,#715336);color:#FCEFDC;box-shadow:0 4px 12px rgba(0,0,0,.12)}
    .tab-panel{display:none}.tab-panel.active{display:block}
    .auth-forms{display:grid;grid-template-columns:1fr;gap:1.5rem;max-width:720px;margin:1.2rem auto 0}
    @media (min-width:900px){.auth-forms{max-width:820px}}
    .field-row{display:flex;align-items:center;justify-content:space-between;gap:.75rem}
    .field-row small{display:flex;align-items:center;gap:.4rem;color:#715336;cursor:pointer;user-select:none}
    .busy{opacity:.7;pointer-events:none}
  </style>
</head>
<body>
<header>
  <a href="index.html" class="logo" aria-label="HireSloth Home">
    <img src="logo.jpg?v=2" alt="HireSloth Logo" width="120" height="120" loading="eager" fetchpriority="high" decoding="async"
      onerror="if (!this.dataset.fallbackTried) { this.dataset.fallbackTried='1'; this.src='logo.jpg?v=2'; } else { this.onerror=null; }">
  </a>
  <nav aria-label="Primary">
    <a href="index.html">Home</a>
    <a href="jobs.html">Vacancies</a>
    <a href="about.html">About</a>
    <a href="contact.html">Contact</a>
    <a href="my-jobs.html" id="myJobsBtn">My Jobs</a>
    <a href="post-job.html" id="postJobBtn">Post a Job</a>
    <!-- Always present; nav.js can gate the click if signed out -->
    <a href="verify.html" id="verifyBtnNav" class="btn">Get Verified</a>
    <a href="auth.html" id="authBtn" class="active" aria-current="page">Sign In</a>
  </nav>
</header>

<main class="content">
  <h1>Welcome to HireSloth</h1>
  <p>Sign in or create an account to post job listings.</p>

  <div class="tabs" role="tablist" aria-label="Authentication">
    <button id="tab-signin" class="tab-btn" role="tab" aria-controls="panel-signin" aria-selected="true">Sign In</button>
    <button id="tab-signup" class="tab-btn" role="tab" aria-controls="panel-signup" aria-selected="false">Sign Up</button>
  </div>

  <div class="auth-forms">
    <section id="panel-signin" class="tab-panel active" role="tabpanel" aria-labelledby="tab-signin" tabindex="0">
      <form id="signinForm" novalidate>
        <label for="signinEmail">Email</label><br>
        <input type="email" id="signinEmail" autocomplete="email" required><br><br>

        <div class="field-row">
          <div style="flex:1">
            <label for="signinPassword">Password</label><br>
            <input type="password" id="signinPassword" autocomplete="current-password" required>
          </div>
          <small>
            <input type="checkbox" id="signinShowPw">
            <label for="signinShowPw">Show</label>
          </small>
        </div>
        <br>

        <button id="signinBtn" type="submit">Sign In</button>
      </form>
      <p id="signinStatus" aria-live="polite"></p>
    </section>

    <section id="panel-signup" class="tab-panel" role="tabpanel" aria-labelledby="tab-signup" tabindex="0">
      <form id="signupForm" novalidate>
        <label for="signupEmail">Email</label><br>
        <input type="email" id="signupEmail" autocomplete="email" required><br><br>

        <div class="field-row">
          <div style="flex:1">
            <label for="signupPassword">Password</label><br>
            <input type="password" id="signupPassword" autocomplete="new-password" required minlength="6">
          </div>
          <small>
            <input type="checkbox" id="signupShowPw">
            <label for="signupShowPw">Show</label>
          </small>
        </div>
        <br>

        <button id="signupBtn" type="submit">Sign Up</button>
      </form>
      <p id="signupStatus" aria-live="polite"></p>
    </section>
  </div>
</main>

<footer><p>&copy; 2025 HireSloth. All rights reserved.</p></footer>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3/+esm";
  const SUPABASE_URL = "https://arzddicguiydfvtwewlq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyemRkaWNndWl5ZGZ2dHdld2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MzA5NDcsImV4cCI6MjA3MzAwNjk0N30.UjZj0XeB8BtjSDsFyf9swxHA26OniI1Mk1ddgSTUXYg";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
  });

  // --- Utils ---
  const qs = new URLSearchParams(location.search);

  // Only allow same-origin returnTo (avoid open redirects)
  function safeReturnTo(val) {
    try {
      if (!val) return "post-job.html";
      const url = new URL(val, location.origin);
      if (url.origin !== location.origin) return "post-job.html";
      // Normalize to path+query+hash
      return url.pathname + url.search + url.hash || "post-job.html";
    } catch { return "post-job.html"; }
  }
  const returnTo = safeReturnTo(qs.get("returnTo")) || "post-job.html";
  const initialMode = (qs.get("mode") === "signup") ? "signup" : "signin";

  // Clean Supabase OAuth fragments / query params once handled
  function cleanAuthParams() {
    const u = new URL(window.location.href);
    let changed = false;
    if (u.hash.includes('access_token=')) { u.hash = ''; changed = true; }
    if (u.searchParams.has('code')) { u.searchParams.delete('code'); changed = true; }
    if (changed) {
      const newSearch = u.searchParams.toString();
      const next = u.pathname + (newSearch ? ("?" + newSearch) : "") + (u.hash || "");
      history.replaceState({}, "", next);
    }
  }

  // Tabs
  const tabSignin = document.getElementById("tab-signin");
  const tabSignup = document.getElementById("tab-signup");
  const panelSignin = document.getElementById("panel-signin");
  const panelSignup = document.getElementById("panel-signup");

  function setTab(mode){
    const isSignin = mode === "signin";
    tabSignin.setAttribute("aria-selected", isSignin ? "true":"false");
    tabSignup.setAttribute("aria-selected", isSignin ? "false":"true");
    panelSignin.classList.toggle("active", isSignin);
    panelSignup.classList.toggle("active", !isSignin);
    (isSignin ? document.getElementById("signinEmail") : document.getElementById("signupEmail"))?.focus();

    // Preserve returnTo while changing mode (no stray "?")
    const u = new URL(window.location.href);
    u.searchParams.set("mode", isSignin ? "signin" : "signup");
    if (returnTo) u.searchParams.set("returnTo", returnTo);
    const next = u.pathname + "?" + u.searchParams.toString();
    history.replaceState(null, "", next);
  }

  tabSignin.addEventListener("click", ()=>setTab("signin"));
  tabSignup.addEventListener("click", ()=>setTab("signup"));
  setTab(initialMode);

  // Show/hide pw
  document.getElementById("signinShowPw").addEventListener("change", e => {
    document.getElementById("signinPassword").type = e.target.checked ? "text":"password";
  });
  document.getElementById("signupShowPw").addEventListener("change", e => {
    document.getElementById("signupPassword").type = e.target.checked ? "text":"password";
  });

  function lock(formEl, btnEl){ formEl.classList.add("busy"); btnEl.disabled=true; btnEl.dataset.label=btnEl.textContent; btnEl.textContent="Working…"; }
  function unlock(formEl, btnEl){ formEl.classList.remove("busy"); btnEl.disabled=false; if(btnEl.dataset.label) btnEl.textContent=btnEl.dataset.label; }

  // If already logged in, bounce to returnTo immediately
  (async ()=>{
    try{
      const { data:{ session } } = await supabase.auth.getSession();
      if (session?.user) {
        localStorage.setItem("hs_authed","1");
        location.replace(returnTo);
        return;
      }
    } finally {
      cleanAuthParams();
    }
  })();

  // --- Sign up ---
  const signupForm = document.getElementById("signupForm");
  const signupBtn  = document.getElementById("signupBtn");
  const signupStatus = document.getElementById("signupStatus");
  signupForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    signupStatus.textContent = "";
    lock(signupForm, signupBtn);
    const email = document.getElementById("signupEmail").value.trim();
    const password = document.getElementById("signupPassword").value.trim();
    try {
      if (!email || !password) throw new Error("Please enter email and password.");
      const { error } = await supabase.auth.signUp({ email, password });
      if (error) throw error;
      signupStatus.textContent = "✅ Sign up successful! Check your email for confirmation.";
      signupStatus.style.color = "green";
      signupForm.reset();
      setTab("signin");
    } catch (err) {
      signupStatus.textContent = "❌ " + (err.message || "Sign-up failed");
      signupStatus.style.color = "red";
    } finally { unlock(signupForm, signupBtn); }
  });

  // --- Sign in ---
  const signinForm = document.getElementById("signinForm");
  const signinBtn  = document.getElementById("signinBtn");
  const signinStatus = document.getElementById("signinStatus");
  signinForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    signinStatus.textContent = "";
    lock(signinForm, signinBtn);
    const email = document.getElementById("signinEmail").value.trim();
    const password = document.getElementById("signinPassword").value.trim();
    try {
      if (!email || !password) throw new Error("Please enter email and password.");
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) throw error;
      localStorage.setItem("hs_authed","1");
      location.replace(returnTo);
    } catch (err) {
      signinStatus.textContent = "❌ " + (err.message || "Sign-in failed");
      signinStatus.style.color = "red";
    } finally { unlock(signinForm, signinBtn); }
  });
</script>

<!-- Shared nav/auth logic -->
<script type="module" src="nav.js?v=20250920d"></script>
<script>
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js', { scope: './' }).catch(()=>{}); }
</script>
</body>
</html>
