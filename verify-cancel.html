<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Checkout cancelled â€“ HireSloth</title>

  <!-- Force HTTPS outside localhost -->
  <script>
    if (location.protocol === 'http:' &&
        location.hostname !== 'localhost' &&
        location.hostname !== '127.0.0.1') {
      location.replace('https://' + location.host + location.pathname + location.search + location.hash);
    }
  </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

  <meta name="robots" content="noindex,follow"/>
  <link rel="stylesheet" href="style.css?v=20250912b">
  <style>.muted{opacity:.85}</style>
</head>
<body>
  <header>
    <a href="index.html" class="logo" aria-label="HireSloth Home">
      <img src="logo.jpg?v=2" alt="HireSloth Logo" width="120" height="120" loading="eager" decoding="async">
    </a>
    <nav aria-label="Primary">
      <a href="index.html">Home</a>
      <a href="verify.html" id="verifyBtnNav" class="btn">Get Verified</a>
      <a href="jobs.html">Vacancies</a>
      <a href="my-jobs.html" id="myJobsBtn">My Jobs</a>
      <a href="auth.html" id="authBtn">Sign In</a>
    </nav>
  </header>

  <main class="content">
    <h1>Checkout cancelled</h1>
    <p class="muted">No worries â€” you can try again any time.</p>

    <p id="cta">
      <a class="btn" id="tryAgain" href="verify.html">Try again</a>
      <a class="btn" id="toMyJobs" href="my-jobs.html" style="display:none">Go to My Jobs</a>
      <a class="btn btn-alt" id="signIn" href="auth.html?mode=signin&returnTo=verify.html" style="display:none">Sign in</a>
    </p>

    <p id="hint" class="muted"></p>
  </main>

  <footer><p>&copy; 2025 HireSloth. All rights reserved.</p></footer>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3/+esm";

    // ðŸ”§ Replace with your real values
    const SUPABASE_URL = "https://arzddicguiydfvtwewlq.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyemRkaWNndWl5ZGZ2dHdld2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MzA5NDcsImV4cCI6MjA3MzAwNjk0N30.UjZj0XeB8BtjSDsFyf9swxHA26OniI1Mk1ddgSTUXYg";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
    });

    const el = (id)=>document.getElementById(id);
    const tryAgain = el('tryAgain');
    const toMyJobs = el('toMyJobs');
    const signIn   = el('signIn');
    const hint     = el('hint');

    function profileIsVerified(p){
      if (!p) return false;
      if ('is_verified' in p) return !!p.is_verified;
      if (p.verified_until){
        const today = new Date(); today.setHours(0,0,0,0);
        return new Date(p.verified_until) >= today;
      }
      return false;
    }

    function pickPaymentLink(){
      const nav = document.getElementById("verifyBtnNav");
      const fromNav = nav?.dataset?.link?.trim();
      const fromWin = (typeof window !== "undefined" && window.STRIPE_PAYMENT_LINK) ? String(window.STRIPE_PAYMENT_LINK).trim() : "";
      return fromNav || fromWin || "";
    }

    function buildCheckoutUrl(base, user, company){
      try {
        const url = new URL(base, location.origin);
        const email = company?.email || user?.email || "";
        const refId = company?.id || user?.id || "";

        if (refId) url.searchParams.set("client_reference_id", refId);
        if (email) url.searchParams.set("prefilled_email", email);
        if (user?.id) url.searchParams.set("prefilled_metadata[user_id]", user.id);
        if (company?.id) url.searchParams.set("prefilled_metadata[company_id]", company.id);
        if (company?.name) url.searchParams.set("prefilled_metadata[company_name]", company.name);
        url.searchParams.set("prefilled_metadata[period]", "annual");
        url.searchParams.set("prefilled_metadata[site]", location.origin);
        return url.toString();
      } catch { return null; }
    }

    (async ()=>{
      const { data:{ session } } = await supabase.auth.getSession();
      const user = session?.user;

      if (!user){
        localStorage.setItem('hs_authed','0');
        signIn.style.display = '';
        hint.textContent = "Sign in to complete verification when youâ€™re ready.";
        tryAgain.href = "verify.html";
        return;
      }

      localStorage.setItem('hs_authed','1');

      // If verified already, steer them to My Jobs
      let verified = false;
      try{
        const { data: prof } = await supabase
          .from('profiles')
          .select('verified_until')
          .eq('id', user.id).maybeSingle();
        if (profileIsVerified(prof)) verified = true;
      }catch{}

      if (!verified){
        try{
          const { data: comp } = await supabase
            .from('companies')
            .select('is_verified')
            .eq('user_id', user.id).maybeSingle();
          if (profileIsVerified(comp)) verified = true;
        }catch{}
      }

      if (verified){
        tryAgain.style.display = 'none';
        toMyJobs.style.display = '';
        hint.textContent = "Looks like your badge is already active. You can view it on your listings.";
      } else {
        // Prefer direct Payment Link if provided
        const baseLink = pickPaymentLink();
        if (baseLink) {
          // Optionally include company context
          let company = null;
          try {
            const { data } = await supabase
              .from('companies')
              .select('id,name,email')
              .eq('user_id', user.id)
              .maybeSingle();
            if (data) company = data;
          } catch {}
          const built = buildCheckoutUrl(baseLink, user, company);
          if (built) tryAgain.href = built;
        }
        hint.textContent = "You can restart checkout when youâ€™re ready.";
      }
    })();
  </script>

  <!-- Shared nav/auth logic -->
  <script type="module" src="nav.js?v=20250920e"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js?v=15', { scope: './' }).catch(()=>{});
    }
  </script>
</body>
</html>
