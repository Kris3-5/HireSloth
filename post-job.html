<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script>
    if (location.protocol === 'http:' &&
        location.hostname !== 'localhost' &&
        location.hostname !== '127.0.0.1') {
      location.replace('https://' + location.host + location.pathname + location.search + location.hash);
    }
  </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <title>HireSloth - Post a Job</title>
  <link rel="canonical" href="https://hiresloth.com/post-job.html">
  <meta name="description" content="Post a vacancy on HireSloth. Listings expire in 30 days.">
  <link rel="icon" href="favicon.ico">
  <!-- Fonts & perf -->
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="style.css?v=20250912a">
</head>
<body>
<header>
  <a href="index.html" class="logo" aria-label="HireSloth Home">
    <img src="logo.jpg?v=2" alt="HireSloth Logo" width="120" height="120" loading="eager" fetchpriority="high" decoding="async"
      onerror="if (!this.dataset.fallbackTried) { this.dataset.fallbackTried='1'; this.src='logo.jpg?v=2'; } else { this.onerror=null; }">
  </a>
  <nav aria-label="Primary">
    <a href="index.html">Home</a>
    <a href="jobs.html">Vacancies</a>
    <a href="about.html">About</a>
    <a href="contact.html">Contact</a>
    <a href="my-jobs.html" id="myJobsBtn">My Jobs</a>
    <a href="post-job.html" id="postJobBtn" class="active" aria-current="page">Post a Job</a>
    <a href="verify.html" id="verifyBtnNav" class="btn">Get Verified</a>
    <a href="auth.html" id="authBtn">Sign In</a>
  </nav>
</header>

<main class="content" id="jobContent">
  <h1>Post a Job</h1>
  <p>Fill out the form below to list your vacancy. Jobs automatically expire after 30 days.</p>

  <p><a class="btn" href="verify.html">Get Verified</a> — stand out with a badge on your listings.</p>

  <form id="jobForm" novalidate>
    <label for="title">Job Title</label><br>
    <input type="text" id="title" required maxlength="140" autocomplete="off"><br><br>

    <label for="company">Company</label><br>
    <input type="text" id="company" required maxlength="120" autocomplete="organization"><br><br>

    <label for="location">Location</label><br>
    <input type="text" id="location" maxlength="120" autocomplete="off"><br><br>

    <label><input type="checkbox" id="remote"> Remote Position</label><br><br>

    <label for="salary">Salary (optional)</label><br>
    <input type="text" id="salary" maxlength="120" autocomplete="off"><br><br>

    <label for="description">Job Summary</label><br>
    <textarea id="description" rows="3" required maxlength="1200" placeholder="Brief overview of the role"></textarea><br><br>

    <label for="responsibilities">Responsibilities</label><br>
    <textarea id="responsibilities" rows="5" maxlength="3000" placeholder="Bullets or short paragraphs"></textarea><br><br>

    <label for="contact_email">Company Contact Email</label><br>
    <input type="email" id="contact_email" required maxlength="200" inputmode="email" autocomplete="email"><br><br>

    <button id="submitBtn" type="submit">Post Job</button>
  </form>

  <p id="formStatus" style="margin-top: 1rem; font-weight: bold;" aria-live="polite"></p>
</main>

<footer><p>&copy; 2025 HireSloth. All rights reserved.</p></footer>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3/+esm";
  const SUPABASE_URL = "https://arzddicguiydfvtwewlq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyemRkaWNndWl5ZGZ2dHdld2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MzA5NDcsImV4cCI6MjA3MzAwNjk0N30.UjZj0XeB8BtjSDsFyf9swxHA26OniI1Mk1ddgSTUXYg";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
  });

  // Require auth
  const { data: { session } } = await supabase.auth.getSession();
  const currentUser = session?.user || null;
  if (!currentUser) {
    location.href = "auth.html?mode=signin&returnTo=" + encodeURIComponent("post-job.html");
    throw new Error("Redirecting to auth");
  }
  localStorage.setItem("hs_authed","1");

  const submitBtn = document.getElementById("submitBtn");
  const jobForm   = document.getElementById("jobForm");
  const statusEl  = document.getElementById("formStatus");

  const lock = (txt="Posting…") => { submitBtn.disabled = true; submitBtn.dataset.label = submitBtn.textContent; submitBtn.textContent = txt; };
  const unlock = () => { submitBtn.disabled = false; if (submitBtn.dataset.label) submitBtn.textContent = submitBtn.dataset.label; };

  // Prefill from companies table (if exists) and/or profile email
  let companyRow = null;
  try {
    const { data } = await supabase
      .from("companies")
      .select("id,name,email")
      .eq("user_id", currentUser.id)
      .maybeSingle();
    if (data) {
      companyRow = data;
      if (data.name)  document.getElementById("company").value = data.name;
      if (data.email) document.getElementById("contact_email").value = data.email;
    }
  } catch {}

  // Fallback: contact email from auth user
  if (!document.getElementById("contact_email").value && currentUser.email) {
    document.getElementById("contact_email").value = currentUser.email;
  }

  const isEmail = (v)=> /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);

  jobForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    statusEl.textContent = ""; statusEl.style.color = "";

    const title  = document.getElementById("title").value.trim();
    const company= document.getElementById("company").value.trim();
    const location = document.getElementById("location").value.trim();
    const remote = document.getElementById("remote").checked;
    const salary = document.getElementById("salary").value.trim();
    const description = document.getElementById("description").value.trim();
    const responsibilities = document.getElementById("responsibilities").value.trim();
    const contact_email = document.getElementById("contact_email").value.trim();

    // Client validation
    if (!title || !company || !description){
      statusEl.textContent = "❌ Please fill in title, company, and summary.";
      statusEl.style.color = "red"; return;
    }
    if (contact_email.length > 200 || !isEmail(contact_email)) {
      statusEl.textContent = "❌ Please enter a valid company contact email.";
      statusEl.style.color = "red"; return;
    }

    // Expiry in 30 days
    const expires_at = new Date(Date.now() + 30*24*60*60*1000).toISOString();

    const job = {
      title, company, location, remote, salary, description, responsibilities, contact_email,
      user_id: currentUser.id,
      approved: false,
      is_active: true,
      expires_at
    };
    if (companyRow?.id) job.company_id = companyRow.id;

    try {
      lock();
      const { error } = await supabase.from("jobs").insert([job]);
      if (error) throw error;
      statusEl.textContent = "✅ Job posted successfully! Awaiting admin approval.";
      statusEl.style.color = "green";
      jobForm.reset();
    } catch (err) {
      console.error(err);
      statusEl.textContent = "❌ " + (err.message || "Could not post job.");
      statusEl.style.color = "red";
    } finally { unlock(); }
  });
</script>

<!-- Shared nav/auth logic -->
<script type="module" src="nav.js?v=20250920a"></script>
<script>
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js', { scope: './' }).catch(()=>{}); }
</script>
</body>
</html>
