<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Force HTTPS in production; allow localhost for dev -->
<script>
  if (location.protocol === 'http:' &&
      location.hostname !== 'localhost' &&
      location.hostname !== '127.0.0.1') {
    location.replace('https://' + location.host + location.pathname + location.search + location.hash);
  }
</script>

<!-- Auto-upgrade any accidental http:// subresources to https:// -->
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

  <title>HireSloth - Post a Job</title>
  <!-- Favicons -->
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="shortcut icon" href="/favicon.ico">

<!-- iOS home screen icon -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<meta name="apple-mobile-web-app-title" content="HireSloth">

<!-- PWA manifest (Android/Chrome uses this for 192/512) -->
<link rel="manifest" href="/site.webmanifest">
  <!-- Help Google pick your site name -->
<meta name="application-name" content="HireSloth">
<meta property="og:site_name" content="HireSloth">

<!-- Address bar color (light/dark) -->
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#715336">
<meta name="theme-color" media="(prefers-color-scheme: dark)"  content="#2a241e">

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://arzddicguiydfvtwewlq.supabase.co" crossorigin>
  <link rel="stylesheet" href="style.css?v=20250912a">
</head>
<body>
  <header>
    <a href="index.html" class="logo"><img src="logo.jpg" alt="HireSloth Logo"></a>
    <nav>
      <a href="index.html">Home</a>
      <a href="jobs.html">Vacancies</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
      <a href="my-jobs.html" id="myJobsBtn">My Jobs</a>
      <a href="post-job.html" id="postJobBtn" class="active">Post a Job</a>
      <a href="auth.html" id="authBtn">Sign In</a>
    </nav>
  </header>

  <main class="content" id="jobContent">
    <h1>Post a Job</h1>
    <p>Fill out the form below to list your vacancy. Jobs automatically expire after 30 days.</p>

    <form id="jobForm">
      <label for="title">Job Title</label><br>
      <input type="text" id="title" required><br><br>

      <label for="company">Company</label><br>
      <input type="text" id="company" required><br><br>

      <label for="location">Location</label><br>
      <input type="text" id="location"><br><br>

      <label><input type="checkbox" id="remote"> Remote Position</label><br><br>

      <label for="salary">Salary (optional)</label><br>
      <input type="text" id="salary"><br><br>

      <label for="description">Job Summary</label><br>
      <textarea id="description" rows="3" required></textarea><br><br>

      <label for="responsibilities">Responsibilities</label><br>
      <textarea id="responsibilities" rows="5"></textarea><br><br>

      <label for="contact_email">Company Contact Email</label><br>
      <input type="email" id="contact_email" required><br><br>

      <button id="submitBtn" type="submit">Post Job</button>
    </form>

    <p id="formStatus" style="margin-top: 1rem; font-weight: bold;"></p>
  </main>

  <footer><p>&copy; 2025 HireSloth. All rights reserved.</p></footer>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3/+esm";
    const SUPABASE_URL="https://arzddicguiydfvtwewlq.supabase.co"; const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyemRkaWNndWl5ZGZ2dHdld2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MzA5NDcsImV4cCI6MjA3MzAwNjk0N30.UjZj0XeB8BtjSDsFyf9swxHA26OniI1Mk1ddgSTUXYg";
    const supabase=createClient(SUPABASE_URL,SUPABASE_ANON_KEY,{auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:true}});

    const authBtn=document.getElementById("authBtn");
    let currentUser=null;

    // Get session once; no timeouts, no flicker
    const { data:{ session } } = await supabase.auth.getSession();
    currentUser = session?.user || null;

    // Hard gate: redirect only if definitely not logged in
    if(!currentUser){
      location.replace("auth.html?mode=signin&returnTo="+encodeURIComponent("post-job.html"));
    }

    // Auth button (confirm on logout)
    function updateAuthBtn(){
      if(currentUser){
        authBtn.textContent="Sign Out"; authBtn.href="#";
        authBtn.onclick=async(e)=>{ e.preventDefault(); if(!confirm("Are you sure you want to log out?")) return; await supabase.auth.signOut(); location.href="index.html"; };
      }else{
        authBtn.textContent="Sign In"; authBtn.href="auth.html"; authBtn.onclick=null;
      }
    }
    updateAuthBtn();
    supabase.auth.onAuthStateChange((event, session)=>{
      if(event==="SIGNED_IN"||event==="SIGNED_OUT"||event==="USER_UPDATED"){
        currentUser=session?.user||null; updateAuthBtn();
      }
    });

    // Form submit
    const jobForm=document.getElementById("jobForm");
    const submitBtn=document.getElementById("submitBtn");
    const statusEl=document.getElementById("formStatus");
    const lock=()=>{ submitBtn.disabled=true; submitBtn.dataset.label=submitBtn.textContent; submitBtn.textContent="Posting…"; };
    const unlock=()=>{ submitBtn.disabled=false; if(submitBtn.dataset.label) submitBtn.textContent=submitBtn.dataset.label; };

    jobForm.addEventListener("submit", async (e)=>{
      e.preventDefault(); statusEl.textContent=""; statusEl.style.color="";
      const user = currentUser; // use cached user
      if(!user){ location.replace("auth.html?mode=signin&returnTo="+encodeURIComponent("post-job.html")); return; }

      const contactEmail=document.getElementById("contact_email").value.trim();
      if(!contactEmail){ statusEl.textContent="❌ Please provide the company contact email."; statusEl.style.color="red"; return; }

      const job={
        title:document.getElementById("title").value.trim(),
        company:document.getElementById("company").value.trim(),
        location:document.getElementById("location").value.trim(),
        remote:document.getElementById("remote").checked,
        salary:document.getElementById("salary").value.trim(),
        description:document.getElementById("description").value.trim(),
        responsibilities:document.getElementById("responsibilities").value.trim(),
        contact_email:contactEmail,
        user_id:user.id,
        approved:false,
        is_active:true,
        expires_at:new Date(Date.now()+30*24*60*60*1000).toISOString()
      };

      try{
        lock();
        const { error } = await supabase.from("jobs").insert([job]);
        if(error) throw error;
        statusEl.textContent="✅ Job posted successfully! Awaiting admin approval.";
        statusEl.style.color="green"; jobForm.reset();
      }catch(err){
        statusEl.textContent="❌ "+(err.message||"Could not post job."); statusEl.style.color="red"; console.error(err);
      }finally{ unlock(); }
    });
  </script>
</body>
</html>
