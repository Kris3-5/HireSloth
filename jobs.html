<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script>
    if (location.protocol === 'http:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
      location.replace('https://' + location.host + location.pathname + location.search + location.hash);
    }
  </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <title>HireSloth - Vacancies</title>
  <link rel="canonical" href="https://hiresloth.com/jobs.html">
  <meta name="description" content="Browse current job openings on HireSloth. Filter by keyword, location, and remote roles.">
  <link rel="icon" href="favicon.ico">
  <!-- Fonts & perf -->
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <!-- Replace "mylink" with your full Supabase URL -->
  <link rel="preconnect" href="https://arzddicguiydfvtwewlq.supabase.co" crossorigin>
  <link rel="stylesheet" href="style.css?v=20250912a">
  <style>
    /* small, unobtrusive verified badge */
    .badge--verified {
      display:inline-flex; align-items:center; gap:.35rem;
      padding:.15rem .55rem; border-radius:999px; font-size:.78rem;
      border:1px solid #2ecc71; color:#2ecc71; vertical-align:middle;
      line-height:1;
    }
    .badge--verified svg { width:14px; height:14px; }
    .job-card { position:relative; }
  </style>
</head>
<body>
<header>
  <a href="index.html" class="logo">
    <img src="logo.jpg?v=2" alt="HireSloth Logo" width="120" height="120" loading="eager" fetchpriority="high" decoding="async"
      onerror="if (!this.dataset.fallbackTried) { this.dataset.fallbackTried='1'; this.src='logo.jpg?v=2'; } else { this.onerror=null; }">
  </a>
  <nav>
    <a href="index.html">Home</a>
    <a href="jobs.html" class="active">Vacancies</a>
    <a href="about.html">About</a>
    <a href="contact.html">Contact</a>
    <a href="my-jobs.html" id="myJobsBtn">My Jobs</a>
    <a href="post-job.html" id="postJobBtn">Post a Job</a>
    <a href="verify.html" id="verifyBtnNav" class="btn">Get Verified</a>
    <a href="auth.html" id="authBtn">Sign In</a>
  </nav>
</header>

<main class="content">
  <h1>Vacancies</h1>
  <p>Browse current job openings. Use filters or search by keyword to find your next opportunity.</p>

  <div class="search-bar">
    <input type="text" id="keyword" placeholder="Keyword (e.g., Frontend)" autocomplete="off">
    <input type="text" id="location" placeholder="Location" autocomplete="off">
    <label><input type="checkbox" id="remote"> Remote only</label>
    <button id="searchBtn">Search</button>
  </div>

  <div class="jobs" id="jobsContainer"></div>
</main>

<footer><p>&copy; 2025 HireSloth. All rights reserved.</p></footer>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3/+esm";

  const SUPABASE_URL = "https://arzddicguiydfvtwewlq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyemRkaWNndWl5ZGZ2dHdld2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MzA5NDcsImV4cCI6MjA3MzAwNjk0N30.UjZj0XeB8BtjSDsFyf9swxHA26OniI1Mk1ddgSTUXYg";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });

  const jobsContainer = document.getElementById("jobsContainer");
  const searchBtn     = document.getElementById("searchBtn");

  const esc = (s) => (s ?? "").toString()
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");

  const verifiedBadge = () => `
    <span class="badge--verified" title="Verified employer">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M9.55 17.05 5.5 13l1.4-1.4 2.65 2.6 7.6-7.6L18.55 8z"/></svg>
      Verified
    </span>`;

  // Support either schema:
  // - profiles: { id, verified_until }
  // - companies: { id, user_id, is_verified } (optional)
  function profileIsVerified(profile){
    if (!profile) return false;
    if ('is_verified' in profile) return !!profile.is_verified;
    if ('verified_until' in profile && profile.verified_until){
      const today = new Date(); today.setHours(0,0,0,0);
      const until = new Date(profile.verified_until);
      return until >= today;
    }
    return false;
  }

  async function fetchVerificationMaps(userIds, companyIds){
    const profMap = {};
    const compMap = {};

    // profiles (safe if table exists)
    if (userIds.length){
      const { data: profiles, error: profErr } = await supabase
        .from("profiles")
        .select("id, verified_until")
        .in("id", userIds);

      if (!profErr && profiles) profiles.forEach(p => { profMap[p.id] = p; });
    }

    // companies (optional; ignore if table doesn't exist or columns differ)
    if (companyIds.length){
      try {
        const { data: companies, error: compErr } = await supabase
          .from("companies")
          .select("id, user_id, is_verified")
          .in("id", companyIds);

        if (!compErr && companies) companies.forEach(c => { compMap[c.id] = c; });
      } catch(_) {/* table may not exist; ignore */}
    }

    return { profMap, compMap };
  }

  async function loadJobs(keyword = "", location = "", remoteOnly = false) {
    jobsContainer.innerHTML = "<p>Loading jobsâ€¦</p>";

    let query = supabase
      .from("jobs")
      .select("*")
      .eq("approved", true)
      .eq("is_active", true);

    if (keyword)   query = query.ilike("title", `%${keyword}%`);
    if (location)  query = query.ilike("location", `%${location}%`);
    if (remoteOnly) query = query.eq("remote", true);

    // Order newest first
    const { data: jobs, error } = await query.order("created_at", { ascending: false });

    if (error) {
      jobsContainer.innerHTML = `<p style="color:red">Error: ${esc(error.message)}</p>`;
      console.error(error);
      return;
    }
    if (!jobs?.length) {
      jobsContainer.innerHTML = "<p>No jobs found.</p>";
      return;
    }

    // Collect ids for verification lookups
    const userIds = [...new Set(jobs.map(j => j.user_id).filter(Boolean))];
    const companyIds = [...new Set(jobs.map(j => j.company_id).filter(Boolean))];

    const { profMap, compMap } = await fetchVerificationMaps(userIds, companyIds);

    jobsContainer.innerHTML = jobs.map(job => {
      const prof = job.user_id ? profMap[job.user_id] : null;
      const comp = job.company_id ? compMap[job.company_id] : null;
      const verified = comp?.is_verified || profileIsVerified(prof);

      const salary = job.salary ? `<p><strong>Salary:</strong> ${esc(job.salary)}</p>` : "";
      const resp   = job.responsibilities ? `<p><strong>Responsibilities:</strong> ${esc(job.responsibilities)}</p>` : "";
      const apply  = job.contact_email
        ? `<a class="btn" href="mailto:${esc(job.contact_email)}?subject=${encodeURIComponent("Application: " + (job.title || "Position"))}">Apply via Email</a>`
        : "";
      const report = `<a class="btn secondary" href="contact.html?report_job=${encodeURIComponent(job.id)}&title=${encodeURIComponent(job.title||"")}&company=${encodeURIComponent(job.company||"")}">Report</a>`;

      return `
        <div class="job-card" data-company-id="${esc(job.company_id||'')}" data-user-id="${esc(job.user_id||'')}">
          <h3>${esc(job.title || "Untitled role")}</h3>
          <p><strong>Company:</strong> ${esc(job.company || "")}${(verified && job.company) ? " " + verifiedBadge() : ""}</p>
          <p><strong>Location:</strong> ${esc(job.location || "N/A")} ${job.remote ? "(Remote)" : ""}</p>
          ${salary}
          <p><strong>Summary:</strong> ${esc(job.description || "")}</p>
          ${resp}
          <div class="actions">${apply} ${report}</div>
        </div>
      `;
    }).join("");
  }

  loadJobs();

  function doSearch(){
    const k = document.getElementById("keyword").value.trim();
    const l = document.getElementById("location").value.trim();
    const r = document.getElementById("remote").checked;
    loadJobs(k, l, r);
  }
  searchBtn.addEventListener("click", doSearch);
  document.getElementById("keyword").addEventListener("keydown", e => { if (e.key === "Enter") { e.preventDefault(); doSearch(); }});
  document.getElementById("location").addEventListener("keydown", e => { if (e.key === "Enter") { e.preventDefault(); doSearch(); }});
</script>

<!-- Shared nav/auth logic -->
<script type="module" src="nav.js"></script>
<script>
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js', { scope: './' }).catch(()=>{}); }
</script>
</body>
</html>
